name: Process Newsletters

on:
  push:
    paths:
      - 'inbox/*.eml'
      - 'import/*.html'
  workflow_dispatch:

jobs:
  process:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install beautifulsoup4 pyyaml git-filter-repo

      - name: Check for files to process
        id: check_files
        run: |
          HAS_FILES=false
          if ls inbox/*.eml 1> /dev/null 2>&1; then
            echo "Found .eml files in inbox"
            HAS_FILES=true
          fi
          if ls import/*.html 1> /dev/null 2>&1; then
            echo "Found .html files in import"
            HAS_FILES=true
          fi
          echo "has_files=$HAS_FILES" >> $GITHUB_OUTPUT

      - name: Process newsletters
        if: steps.check_files.outputs.has_files == 'true'
        env:
          NEWSLETTER_SCRUB_GIT_HISTORY: ${{ vars.NEWSLETTER_SCRUB_GIT_HISTORY || 'false' }}
        run: |
          python scripts/process_inbox.py

      - name: Commit processed newsletters
        if: steps.check_files.outputs.has_files == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # Check if history was rewritten (filter-repo removes remote)
          if ! git remote get-url origin > /dev/null 2>&1; then
            git remote add origin "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git"
          fi

          # Add new newsletters
          git add _newsletters/

          # Remove processed files
          git add -u inbox/
          git add -u import/

          # Add logs if they exist
          if [ -d "logs" ]; then
            git add logs/
          fi

          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Process newsletters

            ðŸ¤– Automated newsletter processing"
          fi

          # Force push if history was scrubbed, otherwise normal push
          if [ "${{ vars.NEWSLETTER_SCRUB_GIT_HISTORY }}" = "true" ]; then
            echo "History was rewritten, force pushing..."
            git push --force origin ${{ github.ref_name }}
          else
            git push
          fi

      - name: Upload processing logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: processing-logs
          path: logs/
          if-no-files-found: ignore

      # Build and deploy site
      - name: Setup Ruby
        if: steps.check_files.outputs.has_files == 'true'
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'
          bundler-cache: true

      - name: Install Gems
        if: steps.check_files.outputs.has_files == 'true'
        run: bundle install --path vendor/bundle

      - name: Build site
        if: steps.check_files.outputs.has_files == 'true'
        run: |
          if [ -f CNAME ]; then
            bundle exec jekyll build --config _config.yml,_config_prod.yml
          else
            bundle exec jekyll build --config _config.yml,_config_preview.yml
          fi
        env:
          JEKYLL_ENV: production

      - name: Upload Pages artifact
        if: steps.check_files.outputs.has_files == 'true'
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

      - name: Deploy to Pages
        if: steps.check_files.outputs.has_files == 'true'
        id: deployment
        uses: actions/deploy-pages@v4
